# Developer Guide

This document centralizes all development-specific information: local setup, CI/CD, testing and quality controls, coding standards, and an in-depth directory map (with GNOME integration details).

## Local Development Workflow

- Install Python deps and check system: `make install`
- Desktop-aware configuration (requires sudo): `make configure`
- Run tests: `make test`
- Lint and format: `make lint` and `make format`
- Coverage (threshold enforced by `MIN_COVERAGE`, default 85): `make coverage-required`

Virtual environment is created in `venv/`. The production wrapper `ydmenu-py-env` activates it when invoked from desktop integrations.

## CI/CD and Releases

- Automated releases are handled by GitHub Actions using `.github/workflows/release.yml` and `.github/release.yml` for note categorization.
- Version bump and tagging are driven by `update_version.sh` which updates `.env`, commits, tags `v<version>`, and pushes.
- Releases can be triggered manually via workflow dispatch or by pushing a tag prefixed with `v`:
  - Manual trigger: GitHub → Actions → Release → Run workflow → provide `version` (e.g., `1.5.3`, `2.0.0-RC1`)
  - What happens:
    - Runs `update_version.sh <version>` to update `.env`, regenerate desktop files, commit, tag `v<version>`, and push
    - Creates a GitHub Release with autogenerated notes
  - Tag push trigger: Pushing a tag like `v1.5.3` also creates a Release with notes based on commits since the previous tag

## Testing and Quality Controls

- Test runner: `pytest` via `make test`
- Coverage targets: `make coverage`, `make coverage-html`, `make coverage-browse`, `make coverage-required`
- Linting: `flake8`, `pylint` via `make lint`
- Formatting: `black` via `make format`
- Test isolation: tests patch `Path.home()` and set `HOME` env var to avoid writing to a real home directory. A cleanup step removes caches and coverage reports.
- Error conditions: Comprehensive exception handling tests
- Integration scenarios: End-to-end workflow validation

Guidelines for tests:
- Mock external processes (yandex-disk, notifications, clipboard) and file operations
- Validate error paths and exception handling
- Keep coverage ≥ 85% on new code

## Coding Standards

- Python
  - Use type hints on function signatures and public APIs
  - Prefer clear, descriptive names and early-return guard clauses
  - Comprehensive but concise logging; explain “why” in comments when non-obvious
  - Avoid duplicate logic; follow DRY and SOLID principles
  - Keep tests in sync with behavior changes
- Bash
  - Preserve existing style and safety patterns
  - Keep functions small; centralize shared logic (e.g., Wayland/X11 detection)

## Project Structure Overview

Top-level highlights:

```
yaDiskDolphinMenu/
├── ydmenu.py                    # Main Python logic (Click CLI)
├── ydmenu-py-env                # Wrapper that activates venv and calls ydmenu.py
├── setup.py                     # Python setup and configuration utility
├── ydpublish-python.desktop(.template)  # Python desktop menu (generated)
├── ydmenu.sh                    # Original shell implementation (deprecated)
├── gnome/                       # GNOME-family integrations (scripts, actions, extensions)
└── doc/                         # Documentation (user + developer)
```

### GNOME Directory Map (What does what)

```
gnome/
├── Makefile.gnome                 # Make targets for GNOME-family FMs
├── scripts/                       # Script-based integration (works everywhere)
│   ├── ydmenu-gnome-wrapper       # Normalizes selection; invokes ydmenu-py-env
│   ├── common/gnome_selection_to_paths.sh  # Converts GNOME env/URIs → POSIX paths
│   └── YaDisk – *                  # User-visible script entries calling the wrapper
├── nautilus/ydmenu_nautilus.py    # Nautilus (Files) Python extension (MenuProvider)
├── nemo/ydmenu_nemo.py            # Nemo Python extension (MenuProvider)
├── caja/ydmenu_caja.py            # Caja Python extension (MenuProvider)
├── nemo/actions/*.nemo_action     # Nemo actions (calls wrapper with %F)
├── caja/actions/*.desktop         # Caja actions (calls wrapper with %F)
└── thunar/uca_fragment.xml        # Thunar custom actions fragment (merged into uca.xml)
```

Responsibilities:
- `scripts/` entries provide a “Scripts → YaDisk – …” menu in Nautilus, and similar script/action entries in Nemo/Caja. They delegate to `ydmenu-gnome-wrapper`.
- `ydmenu-gnome-wrapper` resolves the repo root, collects selection via `common/gnome_selection_to_paths.sh`, and invokes `ydmenu-py-env <Action> [paths...]`.
- Python extensions (`nautilus/nemo/caja`) build a “YaDisk” submenu in the right-click context menu and call `ydmenu-py-env` directly (PATH first, repo fallback). They convert `file://` URIs to POSIX paths.
- Nemo/Caja action files link menu items to the wrapper and pass `%F` (selected files). Thunar merges an XML fragment into `~/.config/Thunar/uca.xml`.

### GNOME Make Targets

- `make gnome-install`: 
  - Nautilus scripts: links `gnome/scripts/*` to `~/.local/share/nautilus/scripts` and ensures executables
  - Nemo actions: links `gnome/nemo/actions/*.nemo_action` to `~/.local/share/nemo/actions`
  - Caja actions: links `gnome/caja/actions/*.desktop` to `~/.local/share/file-manager/actions`
  - Thunar: merges `gnome/thunar/uca_fragment.xml` into `~/.config/Thunar/uca.xml`
- `make gnome-ext-install`: 
  - Installs Python extensions by linking extension files into `~/.local/share/{nautilus,nemo,caja}-python/extensions/` (and restarts file managers)
- Status and uninstall commands: `gnome-status`, `gnome-uninstall`, `gnome-ext-status`, `gnome-ext-uninstall`

### Desktop-Aware System Dependencies

`make install-system-deps` detects session (Wayland/X11) to install the correct clipboard package, detects desktop (KDE vs GNOME), and on GNOME installs Python extension packages only if the corresponding file manager binary is present (e.g., `python3-nemo` only if `nemo` is detected).

## KDE Integration Reference (Python Version)

- `setup.py` generates `ydpublish-python.desktop` from template and creates symlinks under KDE service menu directories unless `--skip-kde` is provided
- `ydpublish-python.desktop` actions execute `ydmenu-py-env <Action> %F %k %c`
- Use `make configure` to perform desktop-aware setup

## Contribution Notes

1. Create feature branches and include tests with changes
2. Keep documentation in sync; update this file for dev-facing changes
3. Ensure all tests pass and linting is clean before opening a PR


